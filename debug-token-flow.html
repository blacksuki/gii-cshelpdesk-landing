<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Flow Debug - giiHelpdesk</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .debug-button:hover {
            background: #218838;
        }
        .debug-button.danger {
            background: #dc3545;
        }
        .debug-button.danger:hover {
            background: #c82333;
        }
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
        }
        .log-entry.error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .log-entry.success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .log-entry.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        .step-indicator {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-size: 12px;
        }
        .step-indicator.completed {
            background: #28a745;
        }
        .step-indicator.current {
            background: #007bff;
        }
        .step-indicator.failed {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Token Flow Debug - giiHelpdesk</h1>
    
    <div class="debug-section">
        <h2>ğŸ“‹ è°ƒè¯•æ­¥éª¤</h2>
        <div id="stepIndicator">
            <div><span class="step-indicator" id="step1">1</span>æ£€æŸ¥ localStorage åˆå§‹çŠ¶æ€</div>
            <div><span class="step-indicator" id="step2">2</span>æ¨¡æ‹Ÿç™»å½• API è°ƒç”¨</div>
            <div><span class="step-indicator" id="step3">3</span>éªŒè¯ token å­˜å‚¨</div>
            <div><span class="step-indicator" id="step4">4</span>æµ‹è¯• API è¯·æ±‚å¤´</div>
            <div><span class="step-indicator" id="step5">5</span>å®Œæ•´æµç¨‹éªŒè¯</div>
        </div>
    </div>

    <div class="debug-section">
        <h2>ğŸš€ æ‰§è¡Œè°ƒè¯•</h2>
        <button class="debug-button" onclick="runFullDebug()">è¿è¡Œå®Œæ•´è°ƒè¯•</button>
        <button class="debug-button" onclick="runStep1()">æ­¥éª¤ 1: æ£€æŸ¥åˆå§‹çŠ¶æ€</button>
        <button class="debug-button" onclick="runStep2()">æ­¥éª¤ 2: æ¨¡æ‹Ÿç™»å½•</button>
        <button class="debug-button" onclick="runStep3()">æ­¥éª¤ 3: éªŒè¯å­˜å‚¨</button>
        <button class="debug-button" onclick="runStep4()">æ­¥éª¤ 4: æµ‹è¯•è¯·æ±‚å¤´</button>
        <button class="debug-button" onclick="runStep5()">æ­¥éª¤ 5: æµç¨‹éªŒè¯</button>
        <button class="debug-button danger" onclick="clearDebugLog()">æ¸…é™¤æ—¥å¿—</button>
        <button class="debug-button danger" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
    </div>

    <div class="debug-section">
        <h2>ğŸ“Š è°ƒè¯•è¾“å‡º</h2>
        <div id="debugOutput" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•</h2>
        <div>
            <label>æµ‹è¯• Token:</label>
            <input type="text" id="testToken" placeholder="è¾“å…¥ JWT token è¿›è¡Œæµ‹è¯•" style="width: 400px; margin: 0 10px;">
            <button class="debug-button" onclick="testCustomToken()">æµ‹è¯•è‡ªå®šä¹‰ Token</button>
        </div>
        <div style="margin-top: 10px;">
            <button class="debug-button" onclick="inspectLocalStorage()">æ£€æŸ¥ localStorage è¯¦æƒ…</button>
            <button class="debug-button" onclick="testApiClientMethods()">æµ‹è¯• API å®¢æˆ·ç«¯æ–¹æ³•</button>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ API å®¢æˆ·ç«¯ï¼ˆä¸çœŸå®å®ç°ä¸€è‡´ï¼‰
        class DebugApiClient {
            constructor() {
                this.config = {
                    baseURL: 'https://api.example.com',
                    retryAttempts: 3,
                    retryDelay: 1000,
                    timeout: 10000
                };
                this.retryAttempts = this.config.retryAttempts;
                this.retryDelay = this.config.retryDelay;
                
                // Initialize token from localStorage
                this.token = this.getStoredToken();
                
                // Bind methods
                this.request = this.request.bind(this);
                this.handleResponse = this.handleResponse.bind(this);
                this.handleError = this.handleError.bind(this);
            }

            getStoredToken() {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || null;
                this.log('Getting stored token:', token ? 'Token found' : 'No token found');
                return token;
            }

            setToken(token) {
                this.log('Setting token:', token ? 'Token provided' : 'No token');
                
                this.token = token;
                if (token) {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    user.token = token;
                    localStorage.setItem('user', JSON.stringify(user));
                    this.log('Token stored in localStorage and instance');
                } else {
                    localStorage.removeItem('user');
                    this.log('Token cleared from localStorage and instance');
                }
            }

            clearToken() {
                this.token = null;
                localStorage.removeItem('user');
                this.log('Token cleared');
            }

            isAuthenticated() {
                return !!this.token;
            }

            request(endpoint, options = {}) {
                const url = `${this.config.baseURL}${endpoint}`;
                
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(this.token && { 'Authorization': `Bearer ${this.token}` })
                    }
                };
                
                const requestOptions = { ...defaultOptions, ...options };
                
                this.log('Request details:', {
                    url,
                    headers: requestOptions.headers,
                    hasToken: !!this.token
                });
                
                return {
                    url,
                    headers: requestOptions.headers,
                    token: this.token,
                    options: requestOptions
                };
            }

            log(message, data) {
                console.log(`[DebugApiClient] ${message}`, data);
                addDebugLog(`[API Client] ${message}`, data, 'info');
            }
        }

        // åˆ›å»ºè°ƒè¯• API å®¢æˆ·ç«¯å®ä¾‹
        const debugApiClient = new DebugApiClient();
        let debugStep = 0;

        function addDebugLog(message, data = null, type = 'info') {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            let logText = `[${timestamp}] ${message}`;
            if (data) {
                if (typeof data === 'object') {
                    logText += '\n' + JSON.stringify(data, null, 2);
                } else {
                    logText += `: ${data}`;
                }
            }
            
            logEntry.textContent = logText;
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }

        function updateStepIndicator(step, status) {
            const indicator = document.getElementById(`step${step}`);
            indicator.className = `step-indicator ${status}`;
            if (status === 'completed') {
                indicator.textContent = 'âœ“';
            } else if (status === 'failed') {
                indicator.textContent = 'âœ—';
            } else if (status === 'current') {
                indicator.textContent = step;
            }
        }

        function runFullDebug() {
            addDebugLog('ğŸš€ å¼€å§‹å®Œæ•´è°ƒè¯•æµç¨‹...', null, 'success');
            debugStep = 0;
            
            setTimeout(() => runStep1(), 500);
            setTimeout(() => runStep2(), 1500);
            setTimeout(() => runStep3(), 2500);
            setTimeout(() => runStep4(), 3500);
            setTimeout(() => runStep5(), 4500);
        }

        function runStep1() {
            addDebugLog('ğŸ“‹ æ­¥éª¤ 1: æ£€æŸ¥ localStorage åˆå§‹çŠ¶æ€', null, 'info');
            updateStepIndicator(1, 'current');
            
            try {
                const user = localStorage.getItem('user');
                const token = debugApiClient.getStoredToken();
                
                addDebugLog('åˆå§‹çŠ¶æ€æ£€æŸ¥ç»“æœ:', {
                    localStorage_user: user ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    apiClient_token: token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    token_length: token ? token.length : 0
                }, 'info');
                
                updateStepIndicator(1, 'completed');
            } catch (error) {
                addDebugLog('æ­¥éª¤ 1 å¤±è´¥:', error.message, 'error');
                updateStepIndicator(1, 'failed');
            }
        }

        function runStep2() {
            addDebugLog('ğŸ” æ­¥éª¤ 2: æ¨¡æ‹Ÿç™»å½• API è°ƒç”¨', null, 'info');
            updateStepIndicator(2, 'current');
            
            try {
                // æ¨¡æ‹Ÿç™»å½•å“åº”
                const mockLoginResponse = {
                    success: true,
                    message: 'Login successful',
                    user: {
                        email: 'test@example.com',
                        domain: 'example.com',
                        emailVerified: true
                    },
                    token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiZG9tYWluIjoidGVzdEBleGFtcGxlLmNvbSIsInR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE2MzQ1Njc4NzQsImV4cCI6MTYzNTQzMTg3NH0.mock_signature',
                    expiresIn: 604800
                };

                addDebugLog('æ¨¡æ‹Ÿç™»å½•å“åº”:', mockLoginResponse, 'info');
                
                // æ¨¡æ‹Ÿ API å®¢æˆ·ç«¯å¤„ç†ç™»å½•å“åº”
                if (mockLoginResponse.success && mockLoginResponse.token) {
                    debugApiClient.setToken(mockLoginResponse.token);
                    addDebugLog('Token è®¾ç½®å®Œæˆ', null, 'success');
                } else {
                    addDebugLog('ç™»å½•å“åº”ç¼ºå°‘ token æˆ– success æ ‡å¿—', mockLoginResponse, 'warning');
                }
                
                updateStepIndicator(2, 'completed');
            } catch (error) {
                addDebugLog('æ­¥éª¤ 2 å¤±è´¥:', error.message, 'error');
                updateStepIndicator(2, 'failed');
            }
        }

        function runStep3() {
            addDebugLog('ğŸ’¾ æ­¥éª¤ 3: éªŒè¯ token å­˜å‚¨', null, 'info');
            updateStepIndicator(3, 'current');
            
            try {
                const user = localStorage.getItem('user');
                const token = debugApiClient.getStoredToken();
                const isAuth = debugApiClient.isAuthenticated();
                
                addDebugLog('Token å­˜å‚¨éªŒè¯ç»“æœ:', {
                    localStorage_user: user ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    apiClient_token: token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    isAuthenticated: isAuth,
                    token_length: token ? token.length : 0
                }, 'info');
                
                if (user && token && isAuth) {
                    addDebugLog('âœ… Token å­˜å‚¨éªŒè¯æˆåŠŸ', null, 'success');
                    updateStepIndicator(3, 'completed');
                } else {
                    addDebugLog('âŒ Token å­˜å‚¨éªŒè¯å¤±è´¥', null, 'error');
                    updateStepIndicator(3, 'failed');
                }
            } catch (error) {
                addDebugLog('æ­¥éª¤ 3 å¤±è´¥:', error.message, 'error');
                updateStepIndicator(3, 'failed');
            }
        }

        function runStep4() {
            addDebugLog('ğŸŒ æ­¥éª¤ 4: æµ‹è¯• API è¯·æ±‚å¤´', null, 'info');
            updateStepIndicator(4, 'current');
            
            try {
                const requestInfo = debugApiClient.request('/api/test');
                
                addDebugLog('API è¯·æ±‚å¤´æµ‹è¯•ç»“æœ:', {
                    url: requestInfo.url,
                    hasAuthorization: !!requestInfo.headers['Authorization'],
                    authorizationValue: requestInfo.headers['Authorization'] || 'æœªè®¾ç½®',
                    bearerPrefix: requestInfo.headers['Authorization'] ? requestInfo.headers['Authorization'].startsWith('Bearer ') : false
                }, 'info');
                
                if (requestInfo.headers['Authorization'] && requestInfo.headers['Authorization'].startsWith('Bearer ')) {
                    addDebugLog('âœ… API è¯·æ±‚å¤´è®¾ç½®æ­£ç¡®', null, 'success');
                    updateStepIndicator(4, 'completed');
                } else {
                    addDebugLog('âŒ API è¯·æ±‚å¤´è®¾ç½®ä¸æ­£ç¡®', null, 'error');
                    updateStepIndicator(4, 'failed');
                }
            } catch (error) {
                addDebugLog('æ­¥éª¤ 4 å¤±è´¥:', error.message, 'error');
                updateStepIndicator(4, 'failed');
            }
        }

        function runStep5() {
            addDebugLog('ğŸ¯ æ­¥éª¤ 5: å®Œæ•´æµç¨‹éªŒè¯', null, 'info');
            updateStepIndicator(5, 'current');
            
            try {
                // ç»¼åˆéªŒè¯
                const user = localStorage.getItem('user');
                const token = debugApiClient.getStoredToken();
                const isAuth = debugApiClient.isAuthenticated();
                const requestInfo = debugApiClient.request('/api/test');
                
                const allChecks = {
                    localStorage_has_user: !!user,
                    apiClient_has_token: !!token,
                    is_authenticated: isAuth,
                    request_has_auth_header: !!requestInfo.headers['Authorization'],
                    auth_header_format: requestInfo.headers['Authorization'] ? 
                        (requestInfo.headers['Authorization'].startsWith('Bearer ') ? 'æ­£ç¡®' : 'é”™è¯¯') : 'æœªè®¾ç½®'
                };
                
                addDebugLog('å®Œæ•´æµç¨‹éªŒè¯ç»“æœ:', allChecks, 'info');
                
                const allPassed = Object.values(allChecks).every(check => 
                    check === true || check === 'æ­£ç¡®' || check === 'å­˜åœ¨'
                );
                
                if (allPassed) {
                    addDebugLog('ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Token æµç¨‹å·¥ä½œæ­£å¸¸', null, 'success');
                    updateStepIndicator(5, 'completed');
                } else {
                    addDebugLog('âš ï¸ éƒ¨åˆ†éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å…·ä½“é—®é¢˜', allChecks, 'warning');
                    updateStepIndicator(5, 'failed');
                }
            } catch (error) {
                addDebugLog('æ­¥éª¤ 5 å¤±è´¥:', error.message, 'error');
                updateStepIndicator(5, 'failed');
            }
        }

        function testCustomToken() {
            const tokenInput = document.getElementById('testToken');
            const token = tokenInput.value.trim();
            
            if (!token) {
                addDebugLog('è¯·è¾“å…¥è¦æµ‹è¯•çš„ token', null, 'warning');
                return;
            }
            
            addDebugLog('ğŸ”§ æµ‹è¯•è‡ªå®šä¹‰ Token:', token, 'info');
            
            try {
                debugApiClient.setToken(token);
                
                // éªŒè¯å­˜å‚¨
                const storedToken = debugApiClient.getStoredToken();
                const isAuth = debugApiClient.isAuthenticated();
                
                addDebugLog('è‡ªå®šä¹‰ Token æµ‹è¯•ç»“æœ:', {
                    input_token: token,
                    stored_token: storedToken,
                    is_authenticated: isAuth,
                    token_match: token === storedToken
                }, 'info');
                
                if (token === storedToken && isAuth) {
                    addDebugLog('âœ… è‡ªå®šä¹‰ Token æµ‹è¯•æˆåŠŸ', null, 'success');
                } else {
                    addDebugLog('âŒ è‡ªå®šä¹‰ Token æµ‹è¯•å¤±è´¥', null, 'error');
                }
            } catch (error) {
                addDebugLog('è‡ªå®šä¹‰ Token æµ‹è¯•å¤±è´¥:', error.message, 'error');
            }
        }

        function inspectLocalStorage() {
            addDebugLog('ğŸ” æ£€æŸ¥ localStorage è¯¦æƒ…', null, 'info');
            
            try {
                const user = localStorage.getItem('user');
                const allKeys = Object.keys(localStorage);
                
                addDebugLog('localStorage è¯¦æƒ…:', {
                    all_keys: allKeys,
                    user_data: user ? JSON.parse(user) : null,
                    user_data_keys: user ? Object.keys(JSON.parse(user)) : []
                }, 'info');
            } catch (error) {
                addDebugLog('localStorage æ£€æŸ¥å¤±è´¥:', error.message, 'error');
            }
        }

        function testApiClientMethods() {
            addDebugLog('ğŸ§ª æµ‹è¯• API å®¢æˆ·ç«¯æ–¹æ³•', null, 'info');
            
            try {
                const methods = {
                    getStoredToken: debugApiClient.getStoredToken(),
                    isAuthenticated: debugApiClient.isAuthenticated(),
                    hasToken: !!debugApiClient.token
                };
                
                addDebugLog('API å®¢æˆ·ç«¯æ–¹æ³•æµ‹è¯•ç»“æœ:', methods, 'info');
            } catch (error) {
                addDebugLog('API å®¢æˆ·ç«¯æ–¹æ³•æµ‹è¯•å¤±è´¥:', error.message, 'error');
            }
        }

        function clearDebugLog() {
            document.getElementById('debugOutput').innerHTML = '';
            addDebugLog('ğŸ“ è°ƒè¯•æ—¥å¿—å·²æ¸…é™¤', null, 'info');
        }

        function clearTestData() {
            localStorage.removeItem('user');
            debugApiClient.clearToken();
            
            // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
            for (let i = 1; i <= 5; i++) {
                updateStepIndicator(i, '');
            }
            
            addDebugLog('ğŸ§¹ æµ‹è¯•æ•°æ®å·²æ¸…é™¤', null, 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            addDebugLog('ğŸš€ è°ƒè¯•é¡µé¢å·²åŠ è½½', null, 'success');
            addDebugLog('å½“å‰ localStorage çŠ¶æ€:', {
                has_user: !!localStorage.getItem('user'),
                api_client_token: !!debugApiClient.getStoredToken()
            }, 'info');
        });
    </script>
</body>
</html>
