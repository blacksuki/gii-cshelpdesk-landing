<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard — giiHelpdeskAgent</title>
    <meta name="description" content="Your giiHelpdesk account dashboard" />
    <link rel="icon" href="../images/giiLogo-noBackgroud32.png" type="image/png" />
    <link rel="stylesheet" href="../css/auth.css" />
    <script src="../js/toast.js" defer></script>
    <script src="../js/api-config.js" defer></script>
    <script src="../js/api-client.js" defer></script>
    <script src="../js/auth.js" defer></script>
    <script src="../js/common.js" defer></script>
  </head>
  <body>
    <div id="site-header"></div>

    <div class="account-container">
      <div class="account-header">
        <h1 class="account-title">Account Dashboard</h1>
        <p class="account-subtitle">
          Manage your subscription and account settings
        </p>
      </div>

      <div class="account-grid">
        <!-- Subscription Card -->
        <div class="account-card">
          <div class="account-card__title">
            <span>📊</span>
            Subscription Status
          </div>
          <div class="account-card__content">
            <div class="account-info">
              <span class="account-info__label">Current Plan</span>
              <span class="account-info__value">
                <span
                  class="subscription-badge subscription-badge--free"
                  id="planBadge"
                  >trial</span
                >
              </span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Status</span>
              <span class="account-info__value" id="subscriptionStatus"
                >Active</span
              >
            </div>
            <div class="account-info">
              <span class="account-info__label">Seats</span>
              <span class="account-info__value" id="seatCount">1</span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Next Billing</span>
              <span class="account-info__value" id="nextBilling">--</span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Email Limit</span>
              <span class="account-info__value" id="emailLimit">max 100</span>
            </div>
            <div style="display: flex; gap: 12px">
              <a
                href="/pricing.html"
                class="auth-btn auth-btn--secondary"
                style="text-decoration: none; text-align: center"
              >
                Upgrade Subscription
              </a>
            </div>
          </div>
        </div>

        <!-- Account Info Card -->
        <div class="account-card">
          <div class="account-card__title">
            <span>👤</span>
            Account Information
          </div>
          <div class="account-card__content">
            <div class="account-info">
              <span class="account-info__label">Domain</span>
              <span class="account-info__value" id="userDomain"
                >Loading...</span
              >
            </div>
            <div class="account-info">
              <span class="account-info__label">Email</span>
              <span class="account-info__value" id="userEmail">Loading...</span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Member Since</span>
              <span class="account-info__value" id="memberSince"
                >Loading...</span
              >
            </div>
            <div class="account-info">
              <span class="account-info__label">Last Login</span>
              <span class="account-info__value" id="lastLogin">Loading...</span>
            </div>
            <div class="account-info"><br /></div>
          </div>
          <div style="display: flex; gap: 12px">
            <a
              href="profile.html"
              class="auth-btn auth-btn--secondary"
              style="text-decoration: none; text-align: center"
            >
              Edit Profile
            </a>
            <!-- <a
              href="billing.html"
              class="auth-btn auth-btn--secondary"
              style="text-decoration: none; text-align: center"
            >
              Billing
            </a> -->
          </div>
        </div>
      </div>

      <!-- Service Policy Management (Pro/Team only) -->
      <div class="account-card" style="margin-bottom: 32px">
        <div class="account-card__title">
          <span>📑</span>
          Service Policies (Pro/Team)
        </div>
        <div class="account-card__content">
          <div
            class="account-info"
            id="policyGate"
            style="display: none; color: var(--color-muted)"
          >
            This feature is available for Pro and Team plans only.
          </div>
          <div id="policyForm" style="display: none">
            <!-- Refund Policy Section -->
            <div style="margin-bottom: 24px">
              <div style="margin-bottom: 8px; font-weight: 500">
                Refund Policy (max 2000 words)
              </div>
              <textarea
                id="refundPolicyText"
                placeholder="Enter your refund policy details here (max 2000 words)..."
                style="
                  width: 100%;
                  min-height: 120px;
                  padding: 8px;
                  margin-bottom: 8px;
                  resize: vertical;
                "
                maxlength="12000"
              ></textarea>
              <div style="font-size: 12px; color: var(--color-muted)">
                Word count: <span id="refundWordCount">0</span>/2000 words, you
                can just copy and paste the content from your Shopify store and
                save it here.
              </div>
              <button
                class="auth-btn auth-btn--secondary"
                onclick="submitPolicy('refund')"
                style="margin-top: 8px"
              >
                Save Refund Policy
              </button>
              <div
                id="refundPolicyStatus"
                style="
                  margin-top: 8px;
                  color: var(--color-muted);
                  font-size: 12px;
                "
              ></div>
            </div>

            <!-- Shipping Policy Section -->
            <div style="margin-bottom: 24px">
              <div style="margin-bottom: 8px; font-weight: 500">
                Shipping Policy (max 2000 words)
              </div>
              <textarea
                id="shippingPolicyText"
                placeholder="Enter your shipping policy details here (max 2000 words)..."
                style="
                  width: 100%;
                  min-height: 120px;
                  padding: 8px;
                  margin-bottom: 8px;
                  resize: vertical;
                "
                maxlength="12000"
              ></textarea>
              <div style="font-size: 12px; color: var(--color-muted)">
                Word count: <span id="shippingWordCount">0</span>/2000 words,
                you can just copy and paste the content from your Shopify store
                and save it here.
              </div>
              <button
                class="auth-btn auth-btn--secondary"
                onclick="submitPolicy('shipping')"
                style="margin-top: 8px"
              >
                Save Shipping Policy
              </button>
              <div
                id="shippingPolicyStatus"
                style="
                  margin-top: 8px;
                  color: var(--color-muted);
                  font-size: 12px;
                "
              ></div>
            </div>

            <!-- <div style="display:flex; gap: 12px; margin-top: 16px;">
              <a href="/policyView.html" class="auth-btn auth-btn--secondary" style="text-decoration:none;">View Policies</a>
            </div> -->
          </div>
        </div>
      </div>
      <!-- Billing History -->
      <div class="account-card" style="margin-bottom: 32px">
        <div class="account-card__title">
          <span>📋</span>
          Billing History
        </div>

        <div
          id="billingHistory"
          style="
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-muted);
          "
        >
          Loading billing history...
        </div>

        <div style="margin-top: 16px; text-align: right">
          <button
            class="auth-btn auth-btn--warning"
            onclick="cancelSubscription()"
            id="cancelBtn"
            style="display: none"
          >
            Cancel Subscription
          </button>
        </div>
        <div class="account-card__title">
          <span></span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="account-card" style="margin-bottom: 32px">
        <div class="account-card__title">
          <span>⚡</span>
          Quick Actions
        </div>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
          "
        >
          <button
            class="auth-btn auth-btn--secondary"
            onclick="openGmailAddon()"
          >
            Open Gmail Add-on
          </button>
          <!-- <button
            class="auth-btn auth-btn--secondary"
            onclick="connectShopify()"
          >
            Connect Shopify
          </button> -->
          <!-- <button
            class="auth-btn auth-btn--secondary"
            onclick="viewDocumentation()"
          >
            View Policy
          </button> -->
          <button
            class="auth-btn auth-btn--secondary"
            onclick="contactSupport()"
          >
            Contact Support
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="account-card">
        <div class="account-card__title">
          <span>📈</span>
          Recent Activity
        </div>
        <div
          id="recentActivity"
          style="
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-muted);
          "
        >
          Loading recent activity...
        </div>
      </div>
    </div>

    <div id="site-footer"></div>

    <script>
      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", function () {
        checkAuthentication();
        loadUserData();
        // loadRecentActivity();
        initPolicySection();
      });

      // Load user data
      async function loadUserData() {
        try {
          const result = await window.apiClient.getAccountInfo();

          if (result.success) {
            console.log("loadUserData: result.data.user", result.data.user);
            try {
              // 1. 获取当前user数据（若不存在则初始化为空对象）
              let user = JSON.parse(localStorage.getItem("user")) || {};

              // 2. 更新subscription部分（确保user对象存在）
              if (result?.data?.user?.subscription) {
                user.subscription = result.data.user.subscription;
              }

              // 3. 存回localStorage
              localStorage.setItem("user", JSON.stringify(user));
            } catch (error) {
              console.error(
                "update user.subscription failedi, please logout and login again:",
                error
              );
              // 可在此处添加备用逻辑（如提示用户、重试等）
            }
            updateDashboard(result.data.user);
          } else {
            Toast.error(
              "Failed to Load Data",
              result.error || "Unable to load your account information."
            );
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          Toast.error(
            "Load Error",
            "An error occurred while loading your data."
          );
        }
      }

      // Update dashboard with user data
      function updateDashboard(userData) {
        // Update subscription info
        if (userData.subscription) {
          const sub = userData.subscription;
          console.log("updateDashboard: sub", sub);
          document.getElementById("planBadge").textContent =
            sub.plan || "trial";
          document.getElementById(
            "planBadge"
          ).className = `subscription-badge subscription-badge--${(
            sub.plan || "trial"
          ).toLowerCase()}`;
          document.getElementById("subscriptionStatus").textContent =
            sub.status || "Active";
          document.getElementById("seatCount").textContent = sub.seats || 1;

          // Show/hide cancel button based on plan
          const cancelBtn = document.getElementById("cancelBtn");
          if (
            sub.plan &&
            sub.plan !== "trial" &&
            sub.plan !== "free" &&
            sub.status.toLowerCase() !== "cancelled"
          ) {
            cancelBtn.style.display = "inline-block";
          } else {
            cancelBtn.style.display = "none";
          }

          // Calculate next billing
          if (sub.nextPayment) {
            // 1. 先拿到“账单日”的 0 点（UTC+8）
            const billDay = new Date(sub.nextPayment._seconds * 1000);
            // billDay.setHours(0, 0, 0, 0); // 21:10 → 00:00
            if (sub.plan === "trial" || sub.status !== "active") {
              document.getElementById("nextBilling").textContent = "--";
            } else {
              document.getElementById("nextBilling").textContent =
                billDay.toLocaleDateString();
            }

            // // 2. 今天 0 点（UTC+8）
            // const today = new Date();
            // today.setHours(0, 0, 0, 0);

            // // 3. 相差天数
            // const msPerDay = 24 * 60 * 60 * 1000;
            // const daysLeft = Math.round((billDay - today) / msPerDay);

            // document.getElementById("nextBilling").textContent =
            //   daysLeft > 0
            //     ? `${daysLeft} day${daysLeft > 1 ? "s" : ""}`
            //     : "Expired";
          }

          // Set email limit based on plan
          const emailLimits = {
            free: "max 100",
            trial: "max 100",
            pro: "1,000/month",
            team: "5,000/month",
          };
          document.getElementById("emailLimit").textContent =
            emailLimits[sub.plan.toLowerCase()] || "max 100";
        }

        // Update account info
        if (userData.profile) {
          document.getElementById("userDomain").textContent =
            userData.domain || "N/A";
          document.getElementById("userEmail").textContent =
            userData.email || "N/A";

          if (userData.createdAt) {
            // const createdDate = new Date(userData.createdAt);
            // document.getElementById('memberSince').textContent = createdDate.toLocaleDateString();
            const createdDate = new Date(userData.createdAt._seconds * 1000);
            document.getElementById("memberSince").textContent =
              createdDate.toLocaleDateString();
          }

          if (userData.lastLogin) {
            const lastLoginDate = new Date(userData.lastLogin._seconds * 1000);
            document.getElementById("lastLogin").textContent =
              lastLoginDate.toLocaleDateString();
          }
        }
      }

      // Load recent activity
      async function loadRecentActivity() {
        try {
          const result = await window.apiClient.getUserActivity();

          if (result.success) {
            displayRecentActivity(result.data);
          } else {
            document.getElementById("recentActivity").innerHTML =
              "No recent activity found.";
          }
        } catch (error) {
          console.error("Error loading activity:", error);
          document.getElementById("recentActivity").innerHTML =
            "Unable to load recent activity.";
        }
      }

      // Display recent activity
      function displayRecentActivity(activities) {
        const container = document.getElementById("recentActivity");

        if (!activities || activities.length === 0) {
          container.innerHTML = "No recent activity found.";
          return;
        }

        const activityList = activities
          .map(
            (activity) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f3f4;">
                    <div>
                        <div style="font-weight: 500;">${activity.action}</div>
                        <div style="font-size: 14px; color: var(--color-muted);">${
                          activity.description
                        }</div>
                    </div>
                    <div style="font-size: 12px; color: var(--color-muted);">
                        ${new Date(activity.timestamp).toLocaleDateString()}
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML = activityList;
      }

      // Action handlers
      function upgradeSubscription() {
        Toast.info("Upgrade", "Redirecting to subscription upgrade page...");
        // TODO: Implement subscription upgrade flow
        setTimeout(() => {
          window.location.href = "pricing.html";
        }, 1500);
      }

      async function cancelSubscription() {
        // Get user info from localStorage for confirmation
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const currentPlan = document.getElementById("planBadge").textContent;

        if (!user.email) {
          Toast.error(
            "Error",
            "User information not found. Please refresh the page and try again."
          );
          return;
        }

        // Enhanced confirmation dialog with more details
        const confirmMessage =
          `Are you sure you want to cancel your ${currentPlan} subscription?\n\n` +
          `You will lose access to premium features at the end of your current billing period.\n\n` +
          `This action cannot be undone.`;

        if (confirm(confirmMessage)) {
          Toast.loading(
            "Cancelling Subscription",
            "Processing your cancellation request..."
          );

          try {
            // Call the API client's cancel subscription method
            const result = await window.apiClient.cancelSubscription();

            if (result.success) {
              Toast.hideLoading();
              Toast.success(
                "Subscription Cancelled",
                "Your subscription has been cancelled successfully. You will retain access until the end of your current billing period."
              );

              // Refresh user data to show updated subscription status
              await loadUserData();

              // Hide the cancel button since subscription is now cancelled
              const cancelBtn = document.getElementById("cancelBtn");
              cancelBtn.style.display = "none";

              // Update the status display
              document.getElementById("subscriptionStatus").textContent =
                "Cancelled";
              document.getElementById("planBadge").textContent =
                currentPlan + " (Cancelled)";
              document.getElementById("planBadge").className =
                "subscription-badge subscription-badge--cancelled";
            } else {
              Toast.hideLoading();
              Toast.error(
                "Cancellation Failed",
                result.error ||
                  "Failed to cancel subscription. Please try again or contact support."
              );
            }
          } catch (error) {
            console.error("Error cancelling subscription:", error);
            Toast.hideLoading();
            Toast.error(
              "Cancellation Error",
              "An error occurred while cancelling your subscription. Please try again or contact support."
            );
          }
        }
      }

      // Load billing history
      async function loadBillingHistory() {
        try {
          const result = await window.apiClient.getBillingHistory();

          if (result.success) {
            displayBillingHistory(result.data);
          } else {
            document.getElementById("billingHistory").innerHTML =
              "No billing history found.";
          }
        } catch (error) {
          console.error("Error loading billing history:", error);
          document.getElementById("billingHistory").innerHTML =
            "Unable to load billing history.";
        }
      }

      // Display billing history
      function displayBillingHistory(history) {
        const container = document.getElementById("billingHistory");

        if (!history || history.length === 0) {
          container.innerHTML = "No billing history found.";
          return;
        }

        const historyList = history
          .map(
            (invoice) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #f1f3f4;">
                    <div>
                        <div style="font-weight: 500;">${
                          invoice.description || "Subscription"
                        }</div>
                        <div style="font-size: 14px; color: var(--color-muted);">Invoice #${
                          invoice.number
                        }</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600;">$${invoice.amount}</div>
                        <div style="font-size: 14px; color: var(--color-muted);">
                            ${new Date(invoice.date).toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML = historyList;
      }

      function openGmailAddon() {
        Toast.info("Gmail Add-on", "Opening Gmail Add-on...");
        // TODO: Implement Gmail Add-on opening
      }

      function connectShopify() {
        Toast.info(
          "Shopify Connection",
          "Redirecting to Shopify authorization..."
        );
        // TODO: Implement Shopify connection flow
      }

      function viewDocumentation() {
        window.location.href = "/policyView.html";
      }
      // Service Policy logic
      function initPolicySection() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const plan = (user?.subscription?.plan || "").toLowerCase();
        const eligible = plan === "pro" || plan === "team";
        document.getElementById("policyGate").style.display = eligible
          ? "none"
          : "block";
        document.getElementById("policyForm").style.display = eligible
          ? "block"
          : "none";

        if (eligible) {
          // Load existing policies
          loadExistingPolicies();

          // Setup word counters
          setupWordCounters();
        }
      }

      // Load existing policies from API
      async function loadExistingPolicies() {
        try {
          const user = JSON.parse(localStorage.getItem("user") || "{}");
          const shopDomain = user.domain;

          if (!shopDomain) return;

          // Load refund policy
          const refundResult = await window.apiClient.getServicePolicy(
            shopDomain,
            "refund"
          );
          if (
            refundResult &&
            refundResult.success &&
            refundResult.data &&
            refundResult.data.parsedData
          ) {
            fmtData = jsonToKeyValue(refundResult.data.parsedData);
            document.getElementById("refundPolicyText").value = fmtData || "";
            updateWordCount("refund");
          }

          // Load shipping policy
          const shippingResult = await window.apiClient.getServicePolicy(
            shopDomain,
            "shipping"
          );
          if (
            shippingResult &&
            shippingResult.success &&
            shippingResult.data &&
            shippingResult.data.parsedData
          ) {
            fmtData = jsonToKeyValue(shippingResult.data.parsedData);
            document.getElementById("shippingPolicyText").value = fmtData || "";
            updateWordCount("shipping");
          }
        } catch (error) {
          console.error("Error loading existing policies:", error);
        }
      }

      // Setup word counters for both policy text areas
      function setupWordCounters() {
        const refundTextarea = document.getElementById("refundPolicyText");
        const shippingTextarea = document.getElementById("shippingPolicyText");

        refundTextarea.addEventListener("input", () =>
          updateWordCount("refund")
        );
        shippingTextarea.addEventListener("input", () =>
          updateWordCount("shipping")
        );
      }

      // Update word count display
      function updateWordCount(policyType) {
        const textarea = document.getElementById(`${policyType}PolicyText`);
        const wordCountEl = document.getElementById(`${policyType}WordCount`);

        if (!textarea || !wordCountEl) return;

        const text = textarea.value.trim();
        const wordCount = text ? text.split(/\s+/).length : 0;
        wordCountEl.textContent = wordCount;

        // Update color based on word count
        if (wordCount > 2000) {
          wordCountEl.style.color = "var(--color-error)";
        } else if (wordCount > 1500) {
          wordCountEl.style.color = "var(--color-warning)";
        } else {
          wordCountEl.style.color = "var(--color-muted)";
        }
      }

      // Submit policy (refund or shipping)
      async function submitPolicy(policyType) {
        try {
          const textarea = document.getElementById(`${policyType}PolicyText`);
          const statusEl = document.getElementById(`${policyType}PolicyStatus`);

          if (!textarea || !statusEl) return;

          const content = textarea.value.trim();
          if (!content) {
            Toast.error(
              "Validation",
              `Please enter your ${policyType} policy content.`
            );
            return;
          }

          // Check word count
          const wordCount = content.split(/\s+/).length;
          if (wordCount > 2000) {
            Toast.error(
              "Validation",
              `${policyType} policy exceeds 2000 words (${wordCount} words). Please reduce the content.`
            );
            return;
          }

          statusEl.textContent = `Saving ${policyType} policy...`;
          statusEl.style.color = "var(--color-info)";

          Toast.loading("Saving", `Processing ${policyType} policy...`);

          const user = JSON.parse(localStorage.getItem("user") || "{}");
          const shopDomain = user.domain;

          if (!shopDomain) {
            Toast.error(
              "Error",
              "Shop domain not found. Please refresh and try again."
            );
            return;
          }

          const res = await window.apiClient.uploadServicePolicy(
            shopDomain,
            policyType,
            content
          );

          Toast.hideLoading();

          if (res) {
            statusEl.textContent = `${policyType} policy saved successfully.`;
            statusEl.style.color = "var(--color-success)";
            Toast.success(
              "Saved",
              `${
                policyType.charAt(0).toUpperCase() + policyType.slice(1)
              } policy saved and processed successfully.`
            );
          } else {
            statusEl.textContent = `Failed to save ${policyType} policy: ${
              res?.error || "Unknown error"
            }`;
            statusEl.style.color = "var(--color-error)";
            Toast.error("Error", res?.error || "Failed to save policy");
          }
        } catch (err) {
          Toast.hideLoading();
          const statusEl = document.getElementById(`${policyType}PolicyStatus`);
          if (statusEl) {
            statusEl.textContent = `Error: ${
              err.message || "Failed to save policy"
            }`;
            statusEl.style.color = "var(--color-error)";
          }
          Toast.error("Error", err.message || "Failed to save policy");
        }
      }

      function contactSupport() {
        Toast.info("Support", "Opening support contact form...");
        // TODO: Implement support contact form
      }

      // Logout function (legacy - now handled by handleLogout in common.js)
      function logout() {
        handleLogout();
      }
    </script>
  </body>
</html>
