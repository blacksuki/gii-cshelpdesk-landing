<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard â€” giiHelpdesk</title>
    <meta name="description" content="Your giiHelpdesk account dashboard" />
    <link rel="stylesheet" href="../css/auth.css" />
    <script src="../js/toast.js" defer></script>
    <script src="../js/api-config.js" defer></script>
    <script src="../js/api-client.js" defer></script>
    <script src="../js/auth.js" defer></script>
    <script src="../js/common.js" defer></script>
  </head>
  <body>
    <div id="site-header"></div>

    <div class="account-container">
      <div class="account-header">
        <h1 class="account-title">Account Dashboard</h1>
        <p class="account-subtitle">
          Manage your subscription and account settings
        </p>
      </div>

      <div class="account-grid">
        <!-- Subscription Card -->
        <div class="account-card">
          <div class="account-card__title">
            <span>ðŸ“Š</span>
            Subscription Status
          </div>
          <div class="account-card__content">
            <div class="account-info">
              <span class="account-info__label">Current Plan</span>
              <span class="account-info__value">
                <span
                  class="subscription-badge subscription-badge--free"
                  id="planBadge"
                  >trial</span
                >
              </span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Status</span>
              <span class="account-info__value" id="subscriptionStatus"
                >Active</span
              >
            </div>
            <div class="account-info">
              <span class="account-info__label">Seats</span>
              <span class="account-info__value" id="seatCount">1</span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Next Billing</span>
              <span class="account-info__value" id="nextBilling">--</span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Email Limit</span>
              <span class="account-info__value" id="emailLimit">max 100</span>
            </div>
            <div style="display: flex; gap: 12px">
              <a
                href="/pricing.html"
                class="auth-btn auth-btn--secondary"
                style="text-decoration: none; text-align: center"
              >
                Upgrade Subscription
              </a>
            </div>
          </div>
        </div>

        <!-- Account Info Card -->
        <div class="account-card">
          <div class="account-card__title">
            <span>ðŸ‘¤</span>
            Account Information
          </div>
          <div class="account-card__content">
            <div class="account-info">
              <span class="account-info__label">Domain</span>
              <span class="account-info__value" id="userDomain"
                >Loading...</span
              >
            </div>
            <div class="account-info">
              <span class="account-info__label">Email</span>
              <span class="account-info__value" id="userEmail">Loading...</span>
            </div>
            <div class="account-info">
              <span class="account-info__label">Member Since</span>
              <span class="account-info__value" id="memberSince"
                >Loading...</span
              >
            </div>
            <div class="account-info">
              <span class="account-info__label">Last Login</span>
              <span class="account-info__value" id="lastLogin">Loading...</span>
            </div>
            <div class="account-info"><br /></div>
          </div>
          <div style="display: flex; gap: 12px">
            <a
              href="profile.html"
              class="auth-btn auth-btn--secondary"
              style="text-decoration: none; text-align: center"
            >
              Edit Profile
            </a>
            <!-- <a
              href="billing.html"
              class="auth-btn auth-btn--secondary"
              style="text-decoration: none; text-align: center"
            >
              Billing
            </a> -->
          </div>
        </div>
      </div>

      <!-- Billing History -->
      <div class="account-card" style="margin-bottom: 32px">
        <div class="account-card__title">
          <span>ðŸ“‹</span>
          Billing History
        </div>

        <div
          id="billingHistory"
          style="
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-muted);
          "
        >
          Loading billing history...
        </div>

        <div style="margin-top: 16px; text-align: right">
          <button
            class="auth-btn auth-btn--warning"
            onclick="cancelSubscription()"
            id="cancelBtn"
            style="display: none"
          >
            Cancel Subscription
          </button>
        </div>
        <div class="account-card__title">
          <span></span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="account-card" style="margin-bottom: 32px">
        <div class="account-card__title">
          <span>âš¡</span>
          Quick Actions
        </div>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
          "
        >
          <button
            class="auth-btn auth-btn--secondary"
            onclick="openGmailAddon()"
          >
            Open Gmail Add-on
          </button>
          <button
            class="auth-btn auth-btn--secondary"
            onclick="connectShopify()"
          >
            Connect Shopify
          </button>
          <button
            class="auth-btn auth-btn--secondary"
            onclick="viewDocumentation()"
          >
            View Documentation
          </button>
          <button
            class="auth-btn auth-btn--secondary"
            onclick="contactSupport()"
          >
            Contact Support
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="account-card">
        <div class="account-card__title">
          <span>ðŸ“ˆ</span>
          Recent Activity
        </div>
        <div
          id="recentActivity"
          style="
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-muted);
          "
        >
          Loading recent activity...
        </div>
      </div>
    </div>

    <div id="site-footer"></div>

    <script>
      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", function () {
        checkAuthentication();
        loadUserData();
        // loadRecentActivity();
      });

      // Load user data
      async function loadUserData() {
        try {
          const result = await window.apiClient.getAccountInfo();

          if (result.success) {
            console.log("loadUserData: result.data.user", result.data.user);
            try {
              // 1. èŽ·å–å½“å‰useræ•°æ®ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡ï¼‰
              let user = JSON.parse(localStorage.getItem("user")) || {};

              // 2. æ›´æ–°subscriptionéƒ¨åˆ†ï¼ˆç¡®ä¿userå¯¹è±¡å­˜åœ¨ï¼‰
              if (result?.data?.user?.subscription) {
                user.subscription = result.data.user.subscription;
              }

              // 3. å­˜å›žlocalStorage
              localStorage.setItem("user", JSON.stringify(user));
            } catch (error) {
              console.error("update user.subscription failedi, please logout and login again:", error);
              // å¯åœ¨æ­¤å¤„æ·»åŠ å¤‡ç”¨é€»è¾‘ï¼ˆå¦‚æç¤ºç”¨æˆ·ã€é‡è¯•ç­‰ï¼‰
            }
            updateDashboard(result.data.user);
          } else {
            Toast.error(
              "Failed to Load Data",
              result.error || "Unable to load your account information."
            );
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          Toast.error(
            "Load Error",
            "An error occurred while loading your data."
          );
        }
      }

      // Update dashboard with user data
      function updateDashboard(userData) {
        // Update subscription info
        if (userData.subscription) {
          const sub = userData.subscription;
          console.log("updateDashboard: sub", sub);
          document.getElementById("planBadge").textContent =
            sub.plan || "trial";
          document.getElementById(
            "planBadge"
          ).className = `subscription-badge subscription-badge--${(
            sub.plan || "trial"
          ).toLowerCase()}`;
          document.getElementById("subscriptionStatus").textContent =
            sub.status || "Active";
          document.getElementById("seatCount").textContent = sub.seats || 1;

          // Show/hide cancel button based on plan
          const cancelBtn = document.getElementById("cancelBtn");
          if (
            sub.plan &&
            sub.plan !== "trial" &&
            sub.plan !== "free" &&
            sub.status.toLowerCase() !== "cancelled"
          ) {
            cancelBtn.style.display = "inline-block";
          } else {
            cancelBtn.style.display = "none";
          }

          // Calculate next billing
          if (sub.nextPayment) {
            // 1. å…ˆæ‹¿åˆ°â€œè´¦å•æ—¥â€çš„ 0 ç‚¹ï¼ˆUTC+8ï¼‰
            const billDay = new Date(sub.nextPayment._seconds * 1000);
            // billDay.setHours(0, 0, 0, 0); // 21:10 â†’ 00:00
            if (sub.plan === "trial" || sub.status !== "active") {
              document.getElementById("nextBilling").textContent = "--";
            } else {
              document.getElementById("nextBilling").textContent =
                billDay.toLocaleDateString();
            }

            // // 2. ä»Šå¤© 0 ç‚¹ï¼ˆUTC+8ï¼‰
            // const today = new Date();
            // today.setHours(0, 0, 0, 0);

            // // 3. ç›¸å·®å¤©æ•°
            // const msPerDay = 24 * 60 * 60 * 1000;
            // const daysLeft = Math.round((billDay - today) / msPerDay);

            // document.getElementById("nextBilling").textContent =
            //   daysLeft > 0
            //     ? `${daysLeft} day${daysLeft > 1 ? "s" : ""}`
            //     : "Expired";
          }

          // Set email limit based on plan
          const emailLimits = {
            free: "max 100",
            trial: "max 100",
            pro: "1,000/month",
            team: "5,000/month",
          };
          document.getElementById("emailLimit").textContent =
            emailLimits[sub.plan.toLowerCase()] || "max 100";
        }

        // Update account info
        if (userData.profile) {
          document.getElementById("userDomain").textContent =
            userData.domain || "N/A";
          document.getElementById("userEmail").textContent =
            userData.email || "N/A";

          if (userData.createdAt) {
            // const createdDate = new Date(userData.createdAt);
            // document.getElementById('memberSince').textContent = createdDate.toLocaleDateString();
            const createdDate = new Date(userData.createdAt._seconds * 1000);
            document.getElementById("memberSince").textContent =
              createdDate.toLocaleDateString();
          }

          if (userData.lastLogin) {
            const lastLoginDate = new Date(userData.lastLogin._seconds * 1000);
            document.getElementById("lastLogin").textContent =
              lastLoginDate.toLocaleDateString();
          }
        }
      }

      // Load recent activity
      async function loadRecentActivity() {
        try {
          const result = await window.apiClient.getUserActivity();

          if (result.success) {
            displayRecentActivity(result.data);
          } else {
            document.getElementById("recentActivity").innerHTML =
              "No recent activity found.";
          }
        } catch (error) {
          console.error("Error loading activity:", error);
          document.getElementById("recentActivity").innerHTML =
            "Unable to load recent activity.";
        }
      }

      // Display recent activity
      function displayRecentActivity(activities) {
        const container = document.getElementById("recentActivity");

        if (!activities || activities.length === 0) {
          container.innerHTML = "No recent activity found.";
          return;
        }

        const activityList = activities
          .map(
            (activity) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f3f4;">
                    <div>
                        <div style="font-weight: 500;">${activity.action}</div>
                        <div style="font-size: 14px; color: var(--color-muted);">${
                          activity.description
                        }</div>
                    </div>
                    <div style="font-size: 12px; color: var(--color-muted);">
                        ${new Date(activity.timestamp).toLocaleDateString()}
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML = activityList;
      }

      // Action handlers
      function upgradeSubscription() {
        Toast.info("Upgrade", "Redirecting to subscription upgrade page...");
        // TODO: Implement subscription upgrade flow
        setTimeout(() => {
          window.location.href = "pricing.html";
        }, 1500);
      }

      async function cancelSubscription() {
        // Get user info from localStorage for confirmation
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const currentPlan = document.getElementById("planBadge").textContent;

        if (!user.email) {
          Toast.error(
            "Error",
            "User information not found. Please refresh the page and try again."
          );
          return;
        }

        // Enhanced confirmation dialog with more details
        const confirmMessage =
          `Are you sure you want to cancel your ${currentPlan} subscription?\n\n` +
          `You will lose access to premium features at the end of your current billing period.\n\n` +
          `This action cannot be undone.`;

        if (confirm(confirmMessage)) {
          Toast.loading(
            "Cancelling Subscription",
            "Processing your cancellation request..."
          );

          try {
            // Call the API client's cancel subscription method
            const result = await window.apiClient.cancelSubscription();

            if (result.success) {
              Toast.hideLoading();
              Toast.success(
                "Subscription Cancelled",
                "Your subscription has been cancelled successfully. You will retain access until the end of your current billing period."
              );

              // Refresh user data to show updated subscription status
              await loadUserData();

              // Hide the cancel button since subscription is now cancelled
              const cancelBtn = document.getElementById("cancelBtn");
              cancelBtn.style.display = "none";

              // Update the status display
              document.getElementById("subscriptionStatus").textContent =
                "Cancelled";
              document.getElementById("planBadge").textContent =
                currentPlan + " (Cancelled)";
              document.getElementById("planBadge").className =
                "subscription-badge subscription-badge--cancelled";
            } else {
              Toast.hideLoading();
              Toast.error(
                "Cancellation Failed",
                result.error ||
                  "Failed to cancel subscription. Please try again or contact support."
              );
            }
          } catch (error) {
            console.error("Error cancelling subscription:", error);
            Toast.hideLoading();
            Toast.error(
              "Cancellation Error",
              "An error occurred while cancelling your subscription. Please try again or contact support."
            );
          }
        }
      }

      // Load billing history
      async function loadBillingHistory() {
        try {
          const result = await window.apiClient.getBillingHistory();

          if (result.success) {
            displayBillingHistory(result.data);
          } else {
            document.getElementById("billingHistory").innerHTML =
              "No billing history found.";
          }
        } catch (error) {
          console.error("Error loading billing history:", error);
          document.getElementById("billingHistory").innerHTML =
            "Unable to load billing history.";
        }
      }

      // Display billing history
      function displayBillingHistory(history) {
        const container = document.getElementById("billingHistory");

        if (!history || history.length === 0) {
          container.innerHTML = "No billing history found.";
          return;
        }

        const historyList = history
          .map(
            (invoice) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #f1f3f4;">
                    <div>
                        <div style="font-weight: 500;">${
                          invoice.description || "Subscription"
                        }</div>
                        <div style="font-size: 14px; color: var(--color-muted);">Invoice #${
                          invoice.number
                        }</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600;">$${invoice.amount}</div>
                        <div style="font-size: 14px; color: var(--color-muted);">
                            ${new Date(invoice.date).toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML = historyList;
      }

      function openGmailAddon() {
        Toast.info("Gmail Add-on", "Opening Gmail Add-on...");
        // TODO: Implement Gmail Add-on opening
      }

      function connectShopify() {
        Toast.info(
          "Shopify Connection",
          "Redirecting to Shopify authorization..."
        );
        // TODO: Implement Shopify connection flow
      }

      function viewDocumentation() {
        Toast.info("Documentation", "Opening documentation...");
        window.open("https://docs.giihelpdesk.com", "_blank");
      }

      function contactSupport() {
        Toast.info("Support", "Opening support contact form...");
        // TODO: Implement support contact form
      }

      // Logout function (legacy - now handled by handleLogout in common.js)
      function logout() {
        handleLogout();
      }
    </script>
  </body>
</html>
