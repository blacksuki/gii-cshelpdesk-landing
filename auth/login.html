<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In ‚Äî giiHelpdeskAgent</title>
    <meta name="description" content="Sign in to your giiHelpdesk account">
    <link rel="icon" href="../images/giiLogo-noBackgroud32.png" type="image/png" />
    <link rel="stylesheet" href="../css/auth.css">
    <script src="../js/toast.js"></script>
    <script src="../js/api-config.js"></script>
    <script src="../js/api-client.js"></script>
    <script src="../js/auth.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">giiHelpdesk</div>
                <div class="auth-subtitle">Welcome back! Sign in to your account</div>
            </div>

            <form class="auth-form" id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="email" class="form-label">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="user@yourdomain.com"
                        required
                        autocomplete="email"
                    >
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-input" 
                        placeholder="Enter your password"
                        required
                        autocomplete="current-password"
                    >
                </div>

                <div class="form-group" style="flex-direction: row; justify-content: space-between; align-items: center;">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="rememberMe" name="rememberMe" style="width: auto;">
                        <span>Remember me</span>
                    </label>
                    <a href="forgot.html" class="auth-link" style="font-size: 14px;">Forgot password?</a>
                </div>

                <button type="button" class="auth-btn" id="submitBtn">
                    <span class="btn-text">Sign In</span>
                    <span class="spinner" style="display: none;"></span>
                </button>
            </form>

            <div class="auth-divider">
                <span>or</span>
            </div>

            <div class="social-login">
                <a href="#" class="social-btn" onclick="handleGoogleLogin()">
                    <span>üîç</span>
                    Continue with Google
                </a>
            </div>

            <div class="auth-links">
                Don't have an account? <a href="register.html" class="auth-link">Create one</a>
            </div>
        </div>
    </div>

    <script>
        // Wait for DOM and scripts to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Check for verification message and redirect parameters
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            const redirect = urlParams.get('redirect');
            const plan = urlParams.get('plan');
            const action = urlParams.get('action');
            
            if (message === 'verification_sent') {
                Toast.success('Verification Email Sent', 'Please check your email and click the verification link to activate your account.');
            } else if (message === 'verification_success') {
                Toast.success('Email Verified', 'Your email has been verified successfully. You can now sign in.');
            } else if (message === 'password_reset_sent') {
                Toast.success('Password Reset Email Sent', 'Please check your email for password reset instructions.');
            } else if (message === 'password_reset_success') {
                Toast.success('Password Reset Success', 'Your password has been reset successfully. You can now sign in with your new password.');
            }
            
            // Show redirect message if applicable
            if (redirect === 'pricing' && plan) {
                Toast.info('Login Required', `Please sign in to continue with the ${plan} plan.`);
            } else if (redirect === 'index' && action === 'start_trial') {
                Toast.info('Login Required', 'Please sign in to start your free trial.');
            }

            // Auto-focus email field
            document.getElementById('email').focus();

            // Handle login button click
            document.getElementById('submitBtn').addEventListener('click', async function(e) {
            console.log('Login button clicked');
            e.preventDefault();
            e.stopPropagation();
            
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const spinner = submitBtn.querySelector('.spinner');
            
            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'inline-block';
            
            try {
                const form = document.getElementById('loginForm');
                const formData = new FormData(form);
                const data = {
                    email: formData.get('email').trim(),
                    password: formData.get('password'),
                    rememberMe: formData.get('rememberMe') === 'on'
                };
                
                // Validation
                if (!data.email || !data.password) {
                    Toast.error('Missing Information', 'Please fill in all required fields.');
                    return;
                }
                
                // Submit login using unified API client
                const result = await window.apiClient.login(data);
                
                if (result.success) {
                    Toast.success('Login Successful', 'Welcome back! Redirecting...');
                    
                    // Note: Token storage is handled by apiClient.setToken()
                    // No need to manually store user data here
                    console.log('Login successful, token should be stored by API client');
                    
                    // Check for redirect parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirect = urlParams.get('redirect');
                    const plan = urlParams.get('plan');
                    const action = urlParams.get('action');
                    
                    let redirectUrl = '../account/dashboard.html';
                    
                    if (redirect === 'pricing' && plan) {
                        // Redirect back to pricing page
                        redirectUrl = `../pricing.html?plan=${plan}`;
                    } else if (redirect === 'index' && action === 'start_trial') {
                        // Redirect to pricing page for free trial
                        redirectUrl = '../pricing.html#free';
                    }
                    
                    // Redirect after token verification
                    setTimeout(() => {
                        if (window.apiClient.isAuthenticated()) {
                            console.log('Redirecting to:', redirectUrl);
                            window.location.href = redirectUrl;
                        } else {
                            console.error('Cannot redirect: user not authenticated');
                            Toast.error('Redirect Error', 'Authentication failed. Please try logging in again.');
                        }
                    }, 600); // 3ÁßíÂêéË∑≥ËΩ¨ÔºåÁªôtokenÈ™åËØÅË∂≥Â§üÊó∂Èó¥
                } else {
                    let errorMessage = 'Login failed. Please try again.';
                    
                    if (result.error === 'INVALID_CREDENTIALS') {
                        errorMessage = 'Invalid email or password. Please check your credentials.';
                    } else if (result.error === 'EMAIL_NOT_VERIFIED') {
                        errorMessage = 'Please verify your email address before signing in.';
                    } else if (result.error === 'ACCOUNT_LOCKED') {
                        errorMessage = 'Your account has been locked due to multiple failed login attempts.';
                    } else if (result.error === 'SUBSCRIPTION_EXPIRED') {
                        errorMessage = 'Your subscription has expired. Please renew to continue.';
                    }
                    
                    Toast.error('Login Failed', errorMessage);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                Toast.error('Login Error', 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
            });

            // Google OAuth login
            window.handleGoogleLogin = function() {
                // Initialize Google OAuth
                // Note: GOOGLE_OAUTH_CLIENT_ID should be configured in your environment
                // For now, using a placeholder - replace with actual client ID from Google Cloud Console
                const googleClientId = window.GOOGLE_OAUTH_CLIENT_ID || 'YOUR_GOOGLE_CLIENT_ID_HERE';
                
                if (googleClientId === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                    Toast.error('Configuration Error', 'Google OAuth Client ID is not configured. Please contact support.');
                    console.error('Google OAuth Client ID not configured');
                    return;
                }
                
                // Wait for Google Identity Services to load
                if (typeof google === 'undefined') {
                    Toast.error('Loading Error', 'Google Sign-In is still loading. Please try again in a moment.');
                    setTimeout(() => window.handleGoogleLogin(), 1000);
                    return;
                }
                
                google.accounts.id.initialize({
                    client_id: googleClientId,
                    callback: async function(response) {
                        try {
                            Toast.loading('Authenticating', 'Signing in with Google...');
                            
                            // Send ID token to backend
                            const result = await window.apiClient.googleOAuth(response.credential);
                            
                            Toast.hideLoading();
                            
                            if (result.success) {
                                const isNewUser = result.data?.requiresDomainSetup;
                                Toast.success(
                                    isNewUser ? 'Welcome!' : 'Login Successful',
                                    isNewUser 
                                        ? 'Account created! Please set up your Shopify domain.'
                                        : 'Welcome back! Redirecting...'
                                );
                                
                                // Check for redirect parameters
                                const urlParams = new URLSearchParams(window.location.search);
                                const redirect = urlParams.get('redirect');
                                const plan = urlParams.get('plan');
                                const action = urlParams.get('action');
                                
                                let redirectUrl = '../account/dashboard.html';
                                
                                // If new user without domain, redirect to domain setup
                                if (isNewUser) {
                                    redirectUrl = '../account/dashboard.html?setup=shopify-domain';
                                } else if (redirect === 'pricing' && plan) {
                                    redirectUrl = `../pricing.html?plan=${plan}`;
                                } else if (redirect === 'index' && action === 'start_trial') {
                                    redirectUrl = '../pricing.html#free';
                                }
                                
                                // Redirect after token verification
                                setTimeout(() => {
                                    if (window.apiClient.isAuthenticated()) {
                                        window.location.href = redirectUrl;
                                    } else {
                                        Toast.error('Redirect Error', 'Authentication failed. Please try logging in again.');
                                    }
                                }, 600);
                            } else {
                                let errorMessage = 'Google login failed. Please try again.';
                                
                                if (result.error === 'INVALID_TOKEN') {
                                    errorMessage = 'Invalid Google token. Please try again.';
                                } else if (result.error === 'EMAIL_NOT_VERIFIED') {
                                    errorMessage = 'Your Google email is not verified.';
                                } else if (result.error === 'AUTH_MISMATCH') {
                                    errorMessage = result.data?.message || 'This email is registered with a different authentication method.';
                                }
                                
                                Toast.error('Login Failed', errorMessage);
                            }
                        } catch (error) {
                            Toast.hideLoading();
                            console.error('Google OAuth error:', error);
                            Toast.error('Login Error', 'An unexpected error occurred. Please try again.');
                        }
                    }
                });
                
                // Trigger Google Sign-In
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        // Fallback: use one-tap if popup is not available
                        google.accounts.oauth2.initTokenClient({
                            client_id: googleClientId,
                            scope: 'email profile',
                            callback: async function(tokenResponse) {
                                // This approach uses OAuth 2.0 token
                                // We need to exchange it for ID token
                                Toast.error('Configuration', 'Please use the Google Sign-In button for better experience.');
                            }
                        });
                    }
                });
            };
        });
    </script>
</body>
</html>

